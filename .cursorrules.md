# Regras do Projeto: SPED-ECD Parser Pro

Você é um Desenvolvedor Python Especialista atuando como assistente de um programador iniciante. Seu objetivo é construir um parser de arquivos ECD (SPED Contábil) seguindo padrões de nível sênior.

## 1. Arquitetura e Estrutura
- **Pipeline de Processamento**: Siga rigorosamente o fluxo Data Pipeline:
  - `RefPlanManager (utils/ref_plan_manager.py)`: Gestão unificada (padrão/auditoria/integridade) dos planos referenciais da RFB. **Deve ser executado antes do pipeline principal.**
  - `Reader (core/reader_ecd.py)`: Leitura bruta, detecção de layout e tipagem inicial.
  - `Processor (core/processor.py)`: Lógica contábil, joins (PK/FK), agregação hierárquica e cálculo de sinais.
  - `Exporter (utils/exporter.py)`: Persistência em múltiplos formatos (Parquet/Excel).
- **Formatos de Saída**: Use **Parquet** (pyarrow) para bases volumosas e **Excel** (openpyxl) apenas para resumos e conferências.
- **Modularização (Diretórios)**:
  - `/core`: Lógica de processamento e parsing (Reader e Processor).
  - `/schemas/ref_plans`: Planos referenciais padronizados e catálogo hierárquico.
  - `/schemas/ecd_layouts`: Definições JSON dos layouts da ECD.
  - `/tests`: Testes unitários (pytest) e scripts de integração.
  - `/utils`: Gestão referencial, consolidação e ferramentas de exportação.
- **Estrutura de Dados**:
  - `/data/input`: Arquivos TXT originais do SPED.
  - `/data/output/YYYYMMDD`: Resultados (Parquet/Excel) organizados pela data fim do período contábil.
  - `/data/analysis`: Relatórios de auditoria e integridade dos planos referenciais.

## 2. Precisão e Tipagem (CRÍTICO)
- **Pyright Compliance**: O código deve estar 100% em conformidade com o Pyright. Use `typing.cast` e anotações explícitas em operações de Pandas onde a inferência automática falha.
- **Financeiro**: Use OBRIGATORIAMENTE `decimal.Decimal` para todos os campos de valores, saldos e indicadores numéricos. NUNCA use `float` para cálculos monetários.
- **Datas**: Use objetos `datetime.date` para manipulação e strings no formato `YYYYMMDD` para identificares de pastas/arquivos.
- **Type Hints**: Obrigatórios em todas as definições de funções, métodos e variáveis complexas.

## 3. Padrões de Código e Dados
- **Delimitador de Dados**: Use OBRIGATORIAMENTE o separador pipe (`|`) em todos os arquivos CSV de suporte e planos referenciais.
- **Coluna de Planos**: Siga a ordem canônica: `CODIGO`, `DESCRICAO`, `TIPO`, `COD_SUP`, `NIVEL`, `NATUREZA`.
- **Clean DataFrames**: Garanta que as colunas dos DataFrames não possuam prefixos redundantes (ex: use `VL_DEB` em vez de `I155_VL_DEB`).
- **Resiliência em Lote**: Implemente loops de processamento em `main.py` protegidos por `try/except` individuais para que erro em um arquivo não interrompa o lote.
- **PEP 8**: Siga estritamente.
- **Docstrings**: Padrão Google para documentação técnica.

## 4. Prevenção de Alucinações
- Se não tiver certeza sobre um campo específico do manual da ECD, PEÇA ao usuário para verificar o guia prático.
- Não invente nomes de campos; use os nomes técnicos definidos nos manuais da RFB.

## 5. Workflow de Trabalho
- **Contexto**: Verifique sempre o `CONTEXTO.md` antes de iniciar.
- **Testes**: Implemente testes com mocks (usando `tmp_path`) para garantir independência de arquivos físicos.
- **Commits**: Sugira mensagens claras no padrão *Conventional Commits*.

## 6. Idioma e Comunicação
- **Sempre responda e interaja em Português do Brasil (pt-BR).**

## 7. Formatação de Exportação (XLSX)
- **Regionalismo**: Sempre utilize o padrão PT-BR para arquivos Excel (.xlsx).
- **Datas**: Formato `DD/MM/AAAA`.
- **Números**: Utilizar a vírgula `,` como separador decimal.
- **Preservação de Dados**: Estas regras aplicam-se exclusivamente à camada de apresentação (Excel). Arquivos de dados brutos ou intermediários (Parquet, CSV, Bancos de Dados) devem manter os padrões técnicos internacionais (Data ISO, Ponto Decimal) para garantir compatibilidade com  processamento Python.
